---
import Page from "@shared/Page.astro";
import type { CollectionEntry, CollectionKey } from "astro:content";
import Layout from "./Layout.astro";

type Props = {
  frontmatter: CollectionEntry<CollectionKey>["data"];
};

const props = Astro.props.frontmatter;
// const contentBlocks = props.content_blocks;

const { content_blocks: contentBlocks, _schema } = props;

const renderers: Record<string, any> = {};
const rendererImports = import.meta.glob("src/components/**/*.schema.astro", {
  eager: true,
});

Object.entries(rendererImports).forEach(([path, obj]: [string, any]) => {
  let name = path.match(/.*\/(.*?)\.schema\.astro$/)?.[1];
  if (!name) return;
  renderers[name] = obj.default;
});

var Renderer = undefined;

if (_schema && _schema in renderers) {
  Renderer = renderers[_schema];
} else if (!contentBlocks) {
  throw new Error(`Tried to output page with unsupported schema: ${_schema}`);
}

// Pass frontmatter into the live context hidden within contentBlocks
contentBlocks.unshift({
  _bookshop_name: "_meta",
  frontmatter: { ...props, content_blocks: undefined },
});
---

<Layout {...props}>
  {
    Renderer ? (
      <Renderer bookshop:live {contentBlocks} />
    ) : (
      <Page bookshop:live {contentBlocks} />
    )
  }
</Layout>

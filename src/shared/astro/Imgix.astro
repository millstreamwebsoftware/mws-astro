---
import ImgixClient from "@imgix/js-core";
import preferences from "@data/preferences.json";

export interface Props {
  image: string;
  width?: number;
  height?: number;
  alt?: string;
  loading?: "lazy" | "eager" | null | undefined;
  decoding?: "async" | "auto" | "sync" | null | undefined;
  style?: string;
  crop?: string;
  fit?: string;
  sizes?: string;
  aspect?: number;
  q?: number;
  auto?: string;
  placeholder?: boolean;
}

var ix: ImgixClient | undefined = preferences.API.imgix?.domain
  ? new ImgixClient({
      domain: preferences.API.imgix?.domain,
      secureURLToken: preferences.API.imgix?.token,
    })
  : undefined;

const {
  image,
  alt,
  style,
  sizes,
  placeholder,
  width: tWidth,
  height: tHeight,
} = Astro.props;
var { aspect } = Astro.props;
const loading = Astro.props.loading ?? "lazy";
const decoding = Astro.props.decoding ?? "async";

const opts = {
  fit: Astro.props.fit ?? "crop",
  crop: Astro.props.crop ?? "center",
  ar: aspect ? `${aspect}:1` : undefined,
  q: Astro.props.q ?? undefined,
  auto: Astro.props.auto ?? "compress,format",
  w: tWidth ?? undefined,
  h: tHeight ?? undefined,
};

const url = Astro.site ? new URL(image, Astro.site) : image;
const file = "public" + image;

let fs: any, getPlaiceholder: any;
let base64, metadata;

// @ts-expect-error
if (!ENV_BOOKSHOP_LIVE) {
  fs = await import("node:fs/promises");
  ({ getPlaiceholder } = await import("plaiceholder"));

  try {
    const f = await fs.readFile(file);

    ({ base64, metadata } = await getPlaiceholder(f));
  } catch (err) {
    console.log(err);
  } finally {
    ix = undefined;
  }
}

const src = ix ? ix.buildURL(url.toString(), opts) : image; // Fallback
const srcset = ix ? ix.buildSrcSet(url.toString(), opts) : undefined;

let width = tWidth || metadata?.width;
let height =
  aspect && width ? Math.floor(width / aspect) : tHeight || metadata?.height;

aspect = width / height;

// {placeholder && base64 && <img class="placeholder" src={base64} />}
---

<>
  {
    // @ts-expect-error
    ENV_BOOKSHOP_LIVE ? (
      <img src={image} {alt} {loading} {decoding} {width} {height} />
    ) : (
      <img
        {srcset}
        {src}
        {alt}
        {loading}
        {decoding}
        {sizes}
        {width}
        {height}
        style={{
          "background-image": `url("${base64}")`,
        }}
      />
    )
  }
</>

<style>
  /* .placeholder {
    filter: blur(5rem);
    position: absolute;
    width: 100%;
    height: 100%;
    inset: 0;
    z-index: -1;
    clip-path: border-box;
  } */

  img {
    max-width: 100%;
    height: auto;
    background-size: cover;
    object-fit: cover;
  }
</style>

<style define:vars={{ aspect }}>
  .placeholder {
    aspect-ratio: var(--aspect);
  }
</style>

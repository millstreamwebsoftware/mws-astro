---
import {
  default as Section,
  type Props as SectionProps,
} from "@layouts/Section.astro";
import Icon from "@shared/icon.astro";
import {
  getTree,
  urlToId,
  type TreeNode,
  getTreeNode,
} from "@mws-astro/navigation";
import { getCollection, type CollectionKey } from "astro:content";

interface Props extends Partial<SectionProps> {
  path?: string;
  tree?: TreeNode<CollectionKey>;
  collection?: CollectionKey;
  maxDepth?: number;
  filter?: string;
  depth?: number;
  parent?: boolean;
  hide_cousins?: boolean;
  icon?: string;
}

const depth = (Astro.props.depth ?? -1) + 1;
const {
  path = Astro.props.filter || undefined,
  maxDepth = 1,
  collection = "pages",
  parent = true,
  hide_cousins = false,
  icon = "",
} = Astro.props;

// const tree = await getPageChildren(urlToId(Astro.request.url), collection);
const currentPath = urlToId(Astro.request.url);

const tree =
  Astro.props.tree ??
  getTreeNode(
    getTree(await getCollection(collection), {
      select: currentPath,
    }),
    path,
    currentPath,
  );

const ComponentWrapper = depth ? Fragment : Section;
const Wrapper = depth ? Fragment : "nav";
---

<ComponentWrapper component="navigation" {...Astro.props}>
  <Wrapper>
    {
      parent && tree && "link" in tree && (
        <div data-depth={depth}>
          <a
            href={tree?.link}
            aria-selected={tree.selected === "selected" ? "true" : "false"}
          >
            {icon && <Icon name={icon} height="1em" />}
            {tree.data?.title}
          </a>
        </div>
      )
    }
    {
      tree?.children !== undefined &&
        Object.entries(tree.children).map(([, child]) => {
          if (collection && child.collection != collection) return;

          const hasChildren =
            child.children && Object.keys(child.children).length;

          // Don't render meta nodes without online children
          if (
            child.data &&
            child.data.status !== "online" &&
            !hasChildren &&
            !child.link
          )
            return;

          const displayChildren =
            depth < maxDepth - 1 &&
            hasChildren &&
            (hide_cousins // Don't render children of unselected nodes
              ? child?.selected == undefined || child?.selected
              : true);

          const selected = child.selected === "selected";
          // let link =
          //   child.href ??
          //   (child.children && // Redirect to first child page if no page exists and not rendering children
          //     !displayChildren &&
          //     Object.values(child.children)[0]?.href) ??
          //   child.link;

          return (
            <>
              <div
                data-depth={depth}
                class:list={{ "has-children": displayChildren }}
              >
                <a
                  href={child.link}
                  aria-selected={selected}
                  class:list={[{ selected }]}
                >
                  {icon && <Icon name={icon} height="1em" />}
                  {child.data?.title}
                </a>
                {!!displayChildren && (
                  <div class="children">
                    <Astro.self
                      tree={child}
                      {depth}
                      {maxDepth}
                      {hide_cousins}
                      {icon}
                      parent={false}
                    />
                  </div>
                )}
              </div>
            </>
          );
        })
    }
  </Wrapper>
</ComponentWrapper>

<style>
  :where(a) {
    display: block;
    font-size: var(--text-size-medium);
    text-decoration: none;

    &.selected {
      font-weight: bold;
    }
  }
</style>

<style lang="scss" is:global>
  section.navigation {
    :where(nav) .children {
      margin-left: 2rem;
    }

    svg {
      justify-self: center;
      height: 100%;
    }
  }

  /* Editor Fallback */
  navigation {
    display: block;
    border: 1px solid grey;
    background-color: white;
    border-radius: 0.5rem;
    padding: 1rem 2rem;

    &::before {
      content: "ðŸ§­ Navigation";
      font-size: var(--text-size-medium);
    }
  }
</style>
